#!/usr/bin/env bash
#
# vpnctl â€” manage multiple OpenVPN profiles via a YAML config.
# Supports:
#   -d/--debug, -v/--verbose       stream logs without tearing down on Ctrl-C
#   -k/--kill                      purge old tun* devices, routes, DNS caches & openvpn procs
#   -p/--profile <key>             select profile
#   -o/--output <file>             output path for backup (default vpn-backup.tar.gz.gpg)
#   -i/--input <file>              input path for restore  (default vpn-backup.tar.gz.gpg)
# Actions: start|up, stop|down, status, backup, restore, backup-stats, set-backup
# Requires: yq (Go-yq or python-yq), openvpn, sudo, gpg (for backup/restore)

set -euo pipefail

CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/vpn_config.yaml"
DEBUG=false
KILL_OLD=false
PROFILE_KEY=""
OUTPUT_FILE=""
INPUT_FILE=""
BACKUP_PATH=""
ACTION=""

# â”€â”€â”€ Parse arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--debug|-v|--verbose)
      DEBUG=true; shift ;;
    -k|--kill)
      KILL_OLD=true; shift ;;
    -p|--profile)
      shift
      [[ -z "$1" || "$1" == -* ]] && { echo "âŒ Missing profile after -p" >&2; exit 1; }
      PROFILE_KEY="$1"; shift ;;
    -o|--output)
      shift
      [[ -z "$1" || "$1" == -* ]] && { echo "âŒ Missing file after -o/--output" >&2; exit 1; }
      OUTPUT_FILE="$1"; shift ;;
    -i|--input)
      shift
      [[ -z "$1" || "$1" == -* ]] && { echo "âŒ Missing file after -i/--input" >&2; exit 1; }
      INPUT_FILE="$1"; shift ;;
    start|up|stop|down|status|backup|restore|backup-stats)
      [[ -n "$ACTION" ]] && { echo "âŒ Multiple actions: $ACTION and $1" >&2; exit 1; }
      ACTION="$1"; shift ;;
    set-backup)
      [[ -n "$ACTION" ]] && { echo "âŒ Multiple actions: $ACTION and $1" >&2; exit 1; }
      ACTION="$1"; shift
      [[ -z "$1" || "$1" == -* ]] && { echo "âŒ Missing backup path after set-backup" >&2; exit 1; }
      BACKUP_PATH="$1"; shift ;;
    *)
      echo "âŒ Unknown argument: $1" >&2
      echo "Usage: vpnctl [-d|-v] [-k] [-p <profile>] [-o <file>] [-i <file>] <start|up|stop|down|status|backup|restore|backup-stats|set-backup <path>>" >&2
      exit 1 ;;
  esac
done

# â”€â”€â”€ Action must be set â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[[ -n "$ACTION" ]] || { echo "âŒ No action specified." >&2; exit 1; }

# Get backup file path from config or fallback to default
get_backup_file(){
  local file_type="$1"  # "output" or "input"
  local config_file="${XDG_CONFIG_HOME:-$HOME/.config}/vpn_config.yaml"
  local default_file="vpn-backup.tar.gz.gpg"
  
  # Check if -o or -i was provided
  if [[ "$file_type" == "output" && -n "$OUTPUT_FILE" ]]; then
    echo "$OUTPUT_FILE"
    return
  elif [[ "$file_type" == "input" && -n "$INPUT_FILE" ]]; then
    echo "$INPUT_FILE"
    return
  fi
  
  # Try to get from config file
  if [[ -f "$config_file" ]]; then
    local config_backup
    if yq --version 2>&1 | grep -q 'eval'; then
      config_backup=$(yq eval -r '.backup.default_file' "$config_file" 2>/dev/null)
    else
      config_backup=$(yq '.backup.default_file' "$config_file" 2>/dev/null)
      config_backup="${config_backup%\"}"; config_backup="${config_backup#\"}"
      config_backup="${config_backup%\'}"; config_backup="${config_backup#\'}"
    fi
    
    if [[ -n "$config_backup" && "$config_backup" != "null" ]]; then
      # Expand path variables
      config_backup="${config_backup/#\~/$HOME}"
      config_backup=$(eval echo "\"$config_backup\"")
      echo "$config_backup"
      return
    fi
  fi
  
  # Fallback to default
  echo "$default_file"
}

set_backup_path(){
  local new_path="$BACKUP_PATH"
  local config_file="${XDG_CONFIG_HOME:-$HOME/.config}/vpn_config.yaml"
  
  # Expand path variables for validation
  new_path="${new_path/#\~/$HOME}"
  new_path=$(eval echo "\"$new_path\"")
  
  echo "ðŸ“ Setting backup path to: $new_path"
  
  # Create config file if it doesn't exist
  if [[ ! -f "$config_file" ]]; then
    echo "ðŸ“ Creating new config file: $config_file"
    mkdir -p "$(dirname "$config_file")"
    cat > "$config_file" << EOF
backup:
  default_file: "$BACKUP_PATH"

vpn:
  # Add your VPN profiles here
EOF
    echo "âœ… Config file created with backup path set."
    return
  fi
  
  # Check if backup section exists and update/create it
  if yq --version 2>&1 | grep -q 'eval'; then
    # Go-yq syntax
    yq eval '.backup.default_file = "'"$BACKUP_PATH"'"' -i "$config_file"
  else
    # Python-yq: convert to JSON, update with jq, convert back to YAML
    local temp_file=$(mktemp)
    yq -j '.' "$config_file" | jq '.backup.default_file = "'"$BACKUP_PATH"'"' | yq -y '.' > "$temp_file" && mv "$temp_file" "$config_file"
  fi
  
  echo "âœ… Backup path updated in $config_file"
}

#â”€â”€ Functions for Backup/Restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
backup_cfg(){
  local out=$(get_backup_file "output")
  echo "ðŸ” Creating encrypted backup â†’ $out"
  cd "$HOME"
  tar czpf - .config/vpn_config.yaml .vpn | \
    gpg --batch --yes --cipher-algo AES256 -c -o "$out"
  echo "âœ… Backup written to $out"
}

restore_cfg(){
  local in=$(get_backup_file "input")
  [[ -f "$in" ]] || { echo "âŒ Backup file '$in' not found."; exit 1; }
  echo "ðŸ”“ Restoring from encrypted backup â†’ $in"
  cd "$HOME"
  gpg --batch -d "$in" | tar xzpf -
  echo "âœ… Configuration restored."
}

backup_stats(){
  local in=$(get_backup_file "input")
  [[ -f "$in" ]] || { echo "âŒ Backup file '$in' not found."; exit 1; }
  
  echo "ðŸ“Š Backup Statistics: $in"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # Get backup file info
  local backup_size=$(du -h "$in" 2>/dev/null | cut -f1)
  local backup_date=$(stat -c %y "$in" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1)
  echo "ðŸ“ Size: $backup_size"
  echo "ðŸ“… Created: $backup_date"
  echo
  
  # Extract and analyze backup content temporarily
  local temp_dir=$(mktemp -d)
  trap "rm -rf '$temp_dir'" EXIT
  
  echo "ðŸ” Analyzing backup content..."
  cd "$temp_dir"
  if gpg --batch --quiet -d "$in" | tar xzf - 2>/dev/null; then
    # Check if vpn_config.yaml exists in backup
    if [[ -f ".config/vpn_config.yaml" ]]; then
      echo "âœ… VPN config found in backup"
      
      # Extract profile names from backup
      local backup_profiles
      if yq --version 2>&1 | grep -q 'eval'; then
        backup_profiles=$(yq eval '.vpn | keys | .[]' ".config/vpn_config.yaml" 2>/dev/null)
      else
        backup_profiles=$(yq '.vpn | keys | .[]' ".config/vpn_config.yaml" 2>/dev/null)
      fi
      
      echo "ðŸ”— Profiles in backup:"
      if [[ -n "$backup_profiles" ]]; then
        echo "$backup_profiles" | sed 's/^/  â€¢ /' | sed 's/"//g'
        local profile_count=$(echo "$backup_profiles" | wc -l)
        echo "   Total: $profile_count profiles"
      else
        echo "  âŒ No profiles found"
      fi
    else
      echo "âŒ No VPN config found in backup"
    fi
    
    # Check .vpn directory
    if [[ -d ".vpn" ]]; then
      echo
      echo "ðŸ“‚ VPN configs in backup:"
      find ".vpn" -name "*.ovpn" | sed 's|^\.vpn/||' | sed 's/^/  â€¢ /'
      local config_count=$(find ".vpn" -name "*.ovpn" | wc -l)
      echo "   Total: $config_count .ovpn files"
    else
      echo "âŒ No .vpn directory found in backup"
    fi
    
    # Compare with current configuration
    echo
    echo "ðŸ”„ Synchronization Status:"
    local current_config="$HOME/.config/vpn_config.yaml"
    if [[ -f "$current_config" ]]; then
      # Create temporary files without backup.default_file for comparison
      local temp_current=$(mktemp)
      local temp_backup=$(mktemp)
      trap "rm -f '$temp_current' '$temp_backup'" EXIT
      
      # Strip backup.default_file from both configs for comparison
      if yq --version 2>&1 | grep -q 'eval'; then
        yq eval 'del(.backup.default_file)' "$current_config" > "$temp_current" 2>/dev/null || cp "$current_config" "$temp_current"
        yq eval 'del(.backup.default_file)' ".config/vpn_config.yaml" > "$temp_backup" 2>/dev/null || cp ".config/vpn_config.yaml" "$temp_backup"
      else
        yq 'del(.backup.default_file)' "$current_config" > "$temp_current" 2>/dev/null || cp "$current_config" "$temp_current"
        yq 'del(.backup.default_file)' ".config/vpn_config.yaml" > "$temp_backup" 2>/dev/null || cp ".config/vpn_config.yaml" "$temp_backup"
      fi
      
      # Compare config files (excluding backup.default_file)
      if diff -q "$temp_backup" "$temp_current" &>/dev/null; then
        echo "âœ… Current config matches backup (ignoring backup path differences)"
      else
        echo "âš ï¸  Current config differs from backup"
        
        # Show profile differences
        local current_profiles
        if yq --version 2>&1 | grep -q 'eval'; then
          current_profiles=$(yq eval '.vpn | keys | .[]' "$current_config" 2>/dev/null | sed 's/"//g' | sort)
        else
          current_profiles=$(yq '.vpn | keys | .[]' "$current_config" 2>/dev/null | sed 's/"//g' | sort)
        fi
        
        backup_profiles=$(echo "$backup_profiles" | sed 's/"//g' | sort)
        
        # Profiles only in current config
        local only_current=$(comm -23 <(echo "$current_profiles") <(echo "$backup_profiles"))
        if [[ -n "$only_current" ]]; then
          echo "   ðŸ“ New profiles since backup:"
          echo "$only_current" | sed 's/^/     â€¢ /'
        fi
        
        # Profiles only in backup
        local only_backup=$(comm -13 <(echo "$current_profiles") <(echo "$backup_profiles"))
        if [[ -n "$only_backup" ]]; then
          echo "   ðŸ—‘ï¸  Profiles removed since backup:"
          echo "$only_backup" | sed 's/^/     â€¢ /'
        fi
      fi
    else
      echo "âŒ No current config found at $current_config"
    fi
  else
    echo "âŒ Failed to decrypt/extract backup"
    exit 1
  fi
}

# â”€â”€â”€ Exit early for backup/restore/backup-stats/set-backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "$ACTION" in
  backup)      backup_cfg; exit 0 ;;
  restore)     restore_cfg; exit 0 ;;
  backup-stats) backup_stats; exit 0 ;;
  set-backup)  set_backup_path; exit 0 ;;
esac

# â”€â”€â”€ From here only VPN commands (start/stop/status) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Common prechecks
[[ -f "$CONFIG_FILE" ]] || { echo "âŒ Config file not found: $CONFIG_FILE" >&2; exit 1; }
command -v yq &>/dev/null || { echo "âŒ 'yq' not found; please install." >&2; exit 1; }

# Select first profile if none is set
if [[ -z "$PROFILE_KEY" ]]; then
  if yq --version 2>&1 | grep -q 'eval'; then
    RAW_KEY=$(yq eval -r '.vpn | keys | .[0]' "$CONFIG_FILE")
  else
    RAW_KEY=$(yq '.vpn | keys | .[0]' "$CONFIG_FILE")
  fi
  PROFILE_KEY="${RAW_KEY//\"/}"
fi

# Load and prepare path from YAML
if yq --version 2>&1 | grep -q 'eval'; then
  RAW_CONF=$(yq eval -r ".vpn.${PROFILE_KEY}.config" "$CONFIG_FILE" 2>/dev/null)
else
  RAW_CONF=$(yq ".vpn.${PROFILE_KEY}.config" "$CONFIG_FILE" 2>/dev/null)
  RAW_CONF="${RAW_CONF%\"}"; RAW_CONF="${RAW_CONF#\"}"
  RAW_CONF="${RAW_CONF%\'}"; RAW_CONF="${RAW_CONF#\'}"
fi
[[ -n "$RAW_CONF" && "$RAW_CONF" != "null" ]] || {
  echo "âŒ No config for profile '$PROFILE_KEY' in $CONFIG_FILE" >&2; exit 1
}

# Normalize & expand (~, $HOME, etc.)
RAW_CONF="${RAW_CONF/#\~/$HOME}"
VPN_CONF=$(eval echo "\"$RAW_CONF\"")
[[ -f "$VPN_CONF" ]] || { echo "âŒ VPN config not found: $VPN_CONF" >&2; exit 1; }

# Runtime paths
USER_ID=$(id -u)
PID_FILE="/run/user/${USER_ID}/${PROFILE_KEY}.pid"
LOG_FILE="/tmp/${PROFILE_KEY}.log"

prepare_sudo(){
  sudo -n true &>/dev/null || {
    echo "ðŸ”’ Requesting sudo credentials..."
    sudo -v || { echo "âŒ sudo authentication failed." >&2; exit 1; }
  }
}

start_vpn(){
  if [[ "$KILL_OLD" == true ]]; then
    echo "ðŸ§¹ Purging old tun* devices, routes, DNS caches & openvpn procsâ€¦"
    for dev in $(ls /sys/class/net | grep '^tun'); do
      sudo ip link delete "$dev" 2>/dev/null || true
      sudo ip route flush dev "$dev" 2>/dev/null || true
    done
    sudo ip route flush cache 2>/dev/null || true
    resolvectl flush-caches 2>/dev/null || true
    sudo pkill openvpn 2>/dev/null || true
  fi

  if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" &>/dev/null; then
    echo "ðŸ”„ '$PROFILE_KEY' already running (PID $(<"$PID_FILE"))."
    return
  fi

  prepare_sudo
  echo "ðŸš€ Starting '$PROFILE_KEY' â†’ $VPN_CONF"
  nohup sudo openvpn --config "$VPN_CONF" >"$LOG_FILE" 2>&1 &
  echo $! >"$PID_FILE"
  echo "âœ… Started (PID $(<"$PID_FILE")). Logs at $LOG_FILE"

  if [[ "$DEBUG" == true ]]; then
    echo "--- Debug: streaming logs (Ctrl+C stops debug only) ---"
    trap 'echo "ðŸ›‘ Exiting debug"; kill "$TAIL_PID" 2>/dev/null; exit 0' SIGINT
    tail -n +1 -F "$LOG_FILE" &
    TAIL_PID=$!
    wait "$TAIL_PID"
    trap - SIGINT
  fi
}

stop_vpn(){
  if [[ -f "$PID_FILE" ]]; then
    PID=$(<"$PID_FILE")
    if kill -0 "$PID" &>/dev/null; then
      echo "ðŸ›‘ Stopping '$PROFILE_KEY' (PID $PID)â€¦"
      sudo kill "$PID" && rm -f "$PID_FILE"
      echo "âœ… Stopped."
    else
      echo "âš ï¸ Process $PID not found; removing stale PID."
      rm -f "$PID_FILE"
    fi
  else
    echo "â„¹ï¸ '$PROFILE_KEY' is not running."
  fi
}

status_vpn(){
  if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" &>/dev/null; then
    echo "âœ… '$PROFILE_KEY' is running (PID $(<"$PID_FILE"))."
  else
    echo "âŒ '$PROFILE_KEY' is not running."
  fi
}

case "$ACTION" in
  start|up)   start_vpn ;;
  stop|down)  stop_vpn  ;;
  status)     status_vpn ;;
esac

